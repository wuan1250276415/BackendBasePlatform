<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="pro.wuan.sys.user.mapper.OrgUserMapper">

	<!-- 分页查询角色关联的用户列表 -->
	<select id="selectPageByRole" resultType="pro.wuan.userapi.entity.OrgUserModel">
		select u.*, (select string_agg(p.name,',') from org_user_post up, org_post p where u.id=up.user_id and up.post_id=p.id) orgUserPostModelNames
		from org_user u inner join org_user_role ur on u.id=ur.user_id and ur.role_id=#{roleId}
		where u.delete_flag='f'
		<if test="userName!=null and userName!=''">
		  and u.user_name like '%'||#{userName}||'%'
		</if>
		<choose>
			<when test="param.sortField!=null and param.sortField!='' and param.sortOrder!=null and param.sortOrder!=''">
				order by u.${param.sortField} ${param.sortOrder}
			</when>
			<otherwise>
				order by u.create_time desc
			</otherwise>
		</choose>
	</select>

	<!-- 根据组织机构id列表查询关联的用户列表 -->
	<select id="getUserListByOrganIdList" resultType="pro.wuan.userapi.entity.OrgUserModel">
		select distinct u.* from org_user u, org_element e
		 where u.status=1 and u.id=e.id and e.type='user'
		 and u.delete_flag=false
		<if test="organIdList != null">
			and
			<foreach collection="organIdList" item="item" index="index" open="(" separator="or" close=")">
				e.tree_ids like <![CDATA['%${item}%']]>
			</foreach>
		</if>
	</select>

	<!-- 根据组织机构id列表查询关联的用户列表,剔除超管和单位管理员 -->
	<select id="getUserListByOrganIdListRemoveAdmin" resultType="pro.wuan.userapi.entity.OrgUserModel">
		select distinct u.* from org_user u, org_element e
		 where u.status=1 and u.type='commonUser' and u.id=e.id and e.type='user'
		 and u.delete_flag=false
		<if test="organIdList != null">
			and
			<foreach collection="organIdList" item="item" index="index" open="(" separator="or" close=")">
				e.tree_ids like <![CDATA['%${item}%']]>
			</foreach>
		</if>
	</select>

</mapper>